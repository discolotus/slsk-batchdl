name: Build, sign and notarize macOS release artifacts

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version/tag to package (e.g. 2.6.1). Used for artifact names only."
        required: false
        type: string
  release:
    types: [published]

permissions:
  contents: write

jobs:
  macos-release:
    runs-on: macos-latest
    env:
      DOTNET_NOLOGO: "true"
      APP_NAME: sldl
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 6 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "6.0.x"

      - name: Resolve version label
        id: ver
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "release" ]]; then
            v="${GITHUB_REF_NAME#v}"
          elif [[ -n "${{ inputs.version }}" ]]; then
            v="${{ inputs.version }}"
          else
            v="dev-${GITHUB_RUN_NUMBER}"
          fi
          echo "version=$v" >> "$GITHUB_OUTPUT"
          echo "Using version: $v"

      - name: Restore
        run: dotnet restore slsk-batchdl.sln

      - name: Publish osx-arm64
        run: |
          dotnet publish slsk-batchdl/slsk-batchdl.csproj \
            -c Release \
            -r osx-arm64 \
            --self-contained true \
            /p:PublishSingleFile=true \
            /p:PublishTrimmed=false \
            /p:AssemblyName=${APP_NAME} \
            -o dist/osx-arm64
          chmod +x dist/osx-arm64/${APP_NAME}

      - name: Publish osx-x64
        run: |
          dotnet publish slsk-batchdl/slsk-batchdl.csproj \
            -c Release \
            -r osx-x64 \
            --self-contained true \
            /p:PublishSingleFile=true \
            /p:PublishTrimmed=false \
            /p:AssemblyName=${APP_NAME} \
            -o dist/osx-x64
          chmod +x dist/osx-x64/${APP_NAME}

      - name: Import Apple Developer ID certificate (optional)
        env:
          APPLE_CERT_P12_BASE64: ${{ secrets.APPLE_CERT_P12_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
        shell: bash
        run: |
          if [[ -z "$APPLE_CERT_P12_BASE64" || -z "$APPLE_CERT_PASSWORD" ]]; then
            echo "Signing cert secrets not set; skipping certificate import."
            exit 0
          fi

          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          CERT_PATH="$RUNNER_TEMP/dev_id.p12"

          echo "$APPLE_CERT_P12_BASE64" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "" "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"

          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$APPLE_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN_PATH"

      - name: Sign binaries (Developer ID, optional)
        env:
          APPLE_DEVELOPER_ID: ${{ secrets.APPLE_DEVELOPER_ID }}
        run: |
          if [[ -z "$APPLE_DEVELOPER_ID" ]]; then
            echo "APPLE_DEVELOPER_ID not set; skipping codesign."
            exit 0
          fi
          codesign --force --options runtime --timestamp --sign "$APPLE_DEVELOPER_ID" dist/osx-arm64/${APP_NAME}
          codesign --force --options runtime --timestamp --sign "$APPLE_DEVELOPER_ID" dist/osx-x64/${APP_NAME}
          codesign --verify --verbose=2 dist/osx-arm64/${APP_NAME}
          codesign --verify --verbose=2 dist/osx-x64/${APP_NAME}

      - name: Zip artifacts (preserve executable bit)
        run: |
          cd dist/osx-arm64 && /usr/bin/zip -r ../sldl_osx-arm64.zip ${APP_NAME}
          cd ../osx-x64 && /usr/bin/zip -r ../sldl_osx-x64.zip ${APP_NAME}

      - name: Verify executable bit survives packaging
        shell: bash
        run: |
          mkdir -p dist/verify/arm64 dist/verify/x64
          unzip -q dist/sldl_osx-arm64.zip -d dist/verify/arm64
          unzip -q dist/sldl_osx-x64.zip -d dist/verify/x64

          test -x dist/verify/arm64/${APP_NAME} || { echo "ERROR: arm64 artifact lost executable bit"; ls -l dist/verify/arm64/${APP_NAME}; exit 1; }
          test -x dist/verify/x64/${APP_NAME} || { echo "ERROR: x64 artifact lost executable bit"; ls -l dist/verify/x64/${APP_NAME}; exit 1; }

          echo "Executable-bit check passed for both macOS artifacts."

      - name: Notarize zip artifacts (optional)
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [[ -z "$APPLE_ID" || -z "$APPLE_APP_SPECIFIC_PASSWORD" || -z "$APPLE_TEAM_ID" ]]; then
            echo "Notarization secrets not set; skipping notarization."
            exit 0
          fi

          xcrun notarytool submit dist/sldl_osx-arm64.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --wait

          xcrun notarytool submit dist/sldl_osx-x64.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --wait

      - name: Staple notarization ticket (optional)
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [[ -z "$APPLE_ID" || -z "$APPLE_APP_SPECIFIC_PASSWORD" || -z "$APPLE_TEAM_ID" ]]; then
            echo "Notarization secrets not set; skipping stapling."
            exit 0
          fi
          xcrun stapler staple dist/osx-arm64/${APP_NAME} || true
          xcrun stapler staple dist/osx-x64/${APP_NAME} || true

      - name: Compute checksums
        run: |
          shasum -a 256 dist/sldl_osx-arm64.zip > dist/sldl_osx-arm64.zip.sha256
          shasum -a 256 dist/sldl_osx-x64.zip > dist/sldl_osx-x64.zip.sha256
          cat dist/*.sha256

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sldl-macos-${{ steps.ver.outputs.version }}
          path: |
            dist/sldl_osx-arm64.zip
            dist/sldl_osx-x64.zip
            dist/*.sha256

      - name: Upload assets to GitHub Release
        if: ${{ github.event_name == 'release' }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/sldl_osx-arm64.zip
            dist/sldl_osx-x64.zip
            dist/*.sha256
